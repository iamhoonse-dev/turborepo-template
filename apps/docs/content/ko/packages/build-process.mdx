import { Callout } from "nextra/components";

# 🏗️ 빌드 방식

이 문서는 이 프로젝트에서 패키지를 어떻게 빌드하는지에 대한 설명을 제공함으로서,
이 프로젝트에서 패키지가 어떻게 빌드되는지에 대한 이해를 돕기 위해 작성되었습니다.

## ⚡ Vite 기반 빌드

이 프로젝트에서 제공되는 패키지들은 Vite를 사용하여 빌드됩니다.

|패키지|빌드 방식|
|---|---|
|`browser-utils`|[Vite](https://vitejs.dev/)|
|`http-clients`|[Vite](https://vitejs.dev/)|
|`node-utils`|[Vite](https://vitejs.dev/)|
|`react-utils`|[Vite](https://vitejs.dev/)|
|`react-ui`|[Vite](https://vitejs.dev/)|

<Callout type="info">
  `eslint-plugin-sample` 패키지와 같은 ESLint 플러그인 패키지는 별도의 빌드 과정을 거치지 않도록 설계되었습니다.
  대신, ESLint 플러그인 패키지는 `lib` 디렉토리에 있는 `index.js` 파일을 그대로 사용하도록
  `package.json`의 `files`, `main`, `exports` 필드에 설정되어 있습니다.
</Callout>

### 채택 의도

Vite 를 사용하여 패키지를 빌드하는 이유는 다음과 같습니다:

> _"각 패키지들을 npm 패키지로 배포할 것을 전제로 하여, Vite의 빌드 기능을 사용하여
각 패키지의 소스 코드를 번들링하고, 최적화된 결과물을 생성하기 위함입니다."_

## 다른 패키지 및 어플리케이션에서의 사용

이 프로젝트의 패키지들을 의존성으로 갖는 다른 패키지 및 어플리케이션에서는 패키지의 빌드된 결과물(`dist`)을 사용하도록 설정되어 있습니다.
이러한 설정은 각 패키지마다 `package.json`의 `files`, `exports` 필드에 정의되어 있습니다.

예시로, `react-utils` 패키지의 `package.json` 파일을 살펴보면 다음과 같이 설정되어 있습니다:

<Callout type="info">
  이러한 설정에 의해 `pnpm`은 `react-utils` 패키지를 의존성으로 갖는 다른 패키지나 어플리케이션에서
  `react-utils` 패키지를 설치할 때, 빌드된 결과물(`dist`)을 사용하게 됩니다.
  즉, `react-utils` 패키지를 사용하는 다른 패키지나 어플리케이션의 `node_modules/@repo/react-utils` 디렉토리에는
  빌드된 결과물(`dist`)이 포함되어 있게 됩니다.
</Callout>

```json filename="packages/react-utils/package.json"
{
  // ...existing code...
  "files": [
    "dist"
  ],
  "exports": {
    "./hooks": {
      "types": "./dist/hooks/index.d.ts",
      "import": "./dist/hooks/index.es.js",
      "require": "./dist/hooks/index.cjs.js"
    },
    "./hocs": {
      "types": "./dist/hocs/index.d.ts",
      "import": "./dist/hocs/index.es.js",
      "require": "./dist/hocs/index.cjs.js"
    },
    "./providers": {
      "types": "./dist/providers/index.d.ts",
      "import": "./dist/providers/index.es.js",
      "require": "./dist/providers/index.cjs.js"
    }
  },
  // ...existing code...
}
```

## 개발 환경(`pnpm dev`)에서의 HMR 지원

앞서 설명한 바와 같이, 이 프로젝트의 패키지들을 의존성으로 갖는 다른 패키지나 어플리케이션에서는
해당 패키지의 실제 빌드된 결과물(`dist`)을 사용하도록 설계되어 있습니다.

따라서, 개발 환경에서 `pnpm dev` 명령어를 실행했을 때에도,
각 패키지의 빌드된 결과물(`dist`)을 사용하여 개발 서버가 실행됩니다.

이 때, 개발 중인 패키지의 변경 사항을 실시간으로 반영할 수 있어야 하므로,
Vite의 HMR(Hot Module Replacement) 기능을 사용하여
각 패키지의 `dev` 스크립트가 다음과 같이 설정되어 있습니다.

```json filename="packages/react-utils/package.json"
{
  // ...existing code...
  "scripts": {
    "dev": "tsc -b && vite build --watch",
    // ...other scripts...
  },
  // ...existing code...
}
```

## Linter 검사 및 TypeScript 검사

이 프로젝트의 패키지들을 의존성으로 갖는 다른 패키지나 어플리케이션에서는
해당 패키지의 실제 빌드된 결과물(`dist`)을 사용하도록 설계되어 있기 때문에,

만약 각 패키지를 사용하는 다른 패키지나 어플리케이션에서 Linter 검사(`pnpm run lint`) 및 TypeScript 검사(`pnpm run check-types`)를 실행하는 시점에서
`dist` 디렉토리가 존재하지 않는다면, 오류가 발생할 수 있습니다.

따라서, Linter 검사 및 TypeScript 검사를 실행하기 전에 모든 패키지들에 대한 `dist` 디렉토리가 생성되어 있다는 것을 보장할 필요가 있습니다.
이를 위해, Turborepo 태스크 중 `lint` 및 `check-types`에 대해서는
빌드 작업(`build`)에 의존하도록 다음과 같이 설정되어 있습니다.

```json filename="turbo.json"
{
  // ...existing code...
  "tasks": {
    // ...other tasks...
    "lint": {
      "dependsOn": ["build", "^lint"]
    },
    "check-types": {
      "dependsOn": ["build", "^check-types"]
    },
    // ...other tasks...
  },
  // ...existing code...
}
```

## 📌 참고

이 프로젝트에서 채택한 빌드 방식에 대한 자세한 내용은 다음 문서를 참고하세요:

- [Turborepo 공식 문서 > publishing-libraries](https://turborepo.com/docs/guides/publishing-libraries)
- [Turborepo 공식 문서 > creating-an-internal-package](https://turborepo.com/docs/crafting-your-repository/creating-an-internal-package)
