# 🧪 Unit Test

## ⚡ Vitest Based

This project uses [Vitest](https://vitest.dev/) as its test runner.

### ⚙️ Vitest Configuration

Common test settings are managed by splitting them into several configuration files under the `configs/vitest-config/configs` directory.
Each package/app can extend or combine these configuration files as needed.

- **`base.ts`**  
  - The file that defines the most basic settings for Vitest.
  - Includes options that should be applied commonly to all packages/apps, such as test coverage report settings.
  - Serves as the base for other environment-specific config files (like `ui.ts`, `node.ts`).

- **`ui.ts`**  
  - A config file specialized for testing in UI environments such as React.
  - Configured to use the JSDOM environment for running UI component tests.

- **`node.ts`**  
  - A config file specialized for testing in Node.js environments.
  - Used for utilities, server code, CLI, etc. that run in Node.
  - Sets the test environment to Node and allows the use of Node-related modules/global objects.

### 📊 Integrated Coverage

To merge coverage reports generated from multiple packages/apps,  
related commands and scripts are defined in the project root `package.json` and in the `configs/vitest-config/configs` package.

- **`collect-json-reports`**  
  - Command: `node dist/scripts/collect-json-outputs.js`
  - Collects individual coverage JSON files generated by each package/app into the `coverage/raw` directory.
  - The actual collection logic is implemented in the `configs/vitest-config/scripts/collect-json-output.ts` script.
  - This script uses glob patterns to find coverage files throughout the workspace and gathers them in one place.

- **`merge-json-reports`**  
  - Command: `nyc merge coverage/raw coverage/merged/merged-coverage.json`
  - Merges the collected coverage JSON files into a single `coverage/merged/merged-coverage.json` file.

- **`report`**  
  - Command: `nyc report -t coverage/merged --report-dir coverage/report --reporter=html --exclude-after-remap false`
  - Generates an HTML coverage report based on the merged coverage results.

- **`view-report`**  
  - Command: `open coverage/report/index.html`
  - Opens the generated HTML coverage report directly in your browser.

## 🌀 Using turbo

This project uses [Turbo](https://turbo.build/) to run test tasks quickly and efficiently,
testing only changed parts and reducing unnecessary duplicate runs.

### 🧪 `test` Task

The `test` task in `turbo.json` is configured as follows:

- **Dependencies**: Each package's parent package (`^test`) and the `@repo/vitest-config#build` task are run first.
- **outputs**: The following files are generated as test results and are cached and shared:
    - `coverage.json`,
    - `apps/*/coverage.json`,
    - `packages/*/coverage.json`,
    - `configs/*/coverage.json`,
    - `shared/*/coverage.json`,
    - `tools/*/coverage.json`
- **Cache strategy**: Turbo reuses previous test results if the files specified in outputs have not changed, speeding up execution.
- **Parallel execution**: Turbo analyzes the dependency graph and runs possible tests in parallel.

### 📊 `merge-json-reports` Task

`configs/vitest-config/turbo.json` defines an automated pipeline for integrating coverage reports as follows:

1. **collect-json-reports**
  - Collects coverage results from each package into one place (`coverage/raw/`).
2. **merge-json-reports**
  - Merges the collected coverage files to generate an integrated coverage JSON.
3. **report**
  - Generates an HTML coverage report from the merged results.
4. **view-report**
  - Opens the report in your browser.

With this process, you can easily integrate and visualize test coverage for the entire monorepo.

## 🖥️ Running Unit Tests Locally

### pnpm Commands

You can run unit tests locally using `pnpm`.
Use the following commands to run unit tests for all packages/apps:

```bash
# Run once
pnpm run test

# Run in watch mode
pnpm run test:watch

# Open the last generated integrated coverage report in your browser
pnpm run view-report
```

## 🤖 Unit Tests in GitHub Actions

Unit tests for this project are automatically run in the `unit-test` job of GitHub Actions.

### Workflow Overview

This workflow performs the following tasks:

- 📥 **Install dependencies**: Installs all workspace dependencies using pnpm.
- 💾 **Use cache**: Actively uses various caches such as Turbo, node_modules, dist, and coverage to speed up tests.
- 🏗️ **Build project**: Builds the entire project and saves the build log as a summary file.
- 🧪 **Run unit tests**: Runs unit tests for all packages/apps and saves the test log as a summary file.
- 📊 **Generate coverage report**: Merges coverage results from multiple packages to generate an integrated coverage report.
- ⬆️ **Upload artifacts**: Uploads key results such as coverage reports and build/test summary logs as GitHub Actions artifacts.

### Main Steps

Each step is executed in the following order:

1. 💾 **Restore Turbo/dependency/build/test/coverage cache**
2. 📥 **Install dependencies**
   `pnpm install --frozen-lockfile`
3. 🏗 **Build project**
   `pnpm run build`
4. 🧪 **Run unit tests**
   `pnpm run test`
5. 📊 **Merge coverage reports**
   `pnpm run merge-json-reports`
6. ⬆️ **Upload artifacts**
   - Coverage report: `configs/vitest-config/coverage/merged`
   - Build/test summary logs

## 📌 Reference

- See the `turbo.json` file for turbo settings.
- For detailed workflow, refer to the `unit-test` job in `.github/workflows/test.yml`.
- Test artifacts (coverage, logs, etc.) can be found in the "Artifacts" section of GitHub Actions.
